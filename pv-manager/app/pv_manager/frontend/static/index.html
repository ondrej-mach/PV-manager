<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PV Manager</title>
    <link rel="stylesheet" href="static/app.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" defer></script>
</head>

<body>
    <header>
        <div class="header-left">
            <h1>PV Manager</h1>
        </div>
        <button type="button" class="secondary" id="settingsBtn">Settings</button>
    </header>
    <main>
        <div id="mainView" class="view">
            <section class="card">
                <h2>System Overview</h2>
                <div class="control-row">
                    <label class="switch-label" for="controlSwitch">Automatic control</label>
                    <button id="controlSwitch" class="toggle-switch" role="switch" aria-checked="false">
                        <span class="knob"></span>
                    </button>
                </div>
                <div id="interventionBanner" class="intervention-banner none" style="margin-top: 1rem;">Current
                    intervention: Not available</div>
                <div id="loadStatusContainer" style="margin-top: 0.5rem; font-size: 0.9rem; color: #64748b;"></div>
                <div id="error" class="message error"></div>

                <div id="summaryWindow" class="meta"></div>
                <div id="trainingState" class="training-state">Training status unknown.</div>
                <div id="trainingError" class="training-state error" style="display:none;"></div>
                <div id="cycleMessage" class="message" style="display:none;"></div>
                <div class="actions">
                    <button type="button" id="cycleBtn">Recompute Plan</button>
                    <button type="button" id="trainBtn">Train predictors</button>
                </div>
            </section>

            <section class="card">
                <h2>Forecast vs Load</h2>
                <p class="meta">Last updated: <span id="lastUpdated">waiting…</span></p>
                <div id="forecastMessage" class="message"></div>
                <div id="forecastSummary"
                    style="margin-top:-0.5rem; margin-bottom:0.5rem; font-size:0.9rem; color: #64748b;"></div>
                <div class="chart-container chart-forecast">
                    <canvas id="forecastChart" height="320"></canvas>
                </div>
            </section>

            <section class="card">
                <h2>Optimization Plan</h2>
                <div class="optimization-charts">
                    <div class="optimization-block">
                        <h3 class="chart-subtitle">Price and Battery SoC</h3>
                        <div class="chart-container chart-plan">
                            <canvas id="planChart" height="320"></canvas>
                        </div>
                    </div>
                    <div class="optimization-block">
                        <h3 class="chart-subtitle">Grid exchange</h3>
                        <div id="gridSummary"
                            style="margin-top:-0.5rem; margin-bottom:0.5rem; font-size:0.9rem; color: #64748b;"></div>
                        <div class="chart-container chart-grid">
                            <canvas id="gridChart" height="320"></canvas>
                        </div>
                    </div>
                    <div class="optimization-block">
                        <h3 class="chart-subtitle">Scheduled Flexible Loads</h3>
                        <div id="deferrableLoadSummary"
                            style="margin-top:-0.5rem; margin-bottom:0.5rem; font-size:0.9rem; color: #64748b;"></div>
                        <div class="chart-container chart-deferrable">
                            <canvas id="deferrableLoadChart" height="320"></canvas>
                        </div>
                    </div>
                </div>
        </div>
        </section>
        </div>
        <div id="settingsView" class="view hidden">
            <section class="card">
                <h2>Settings</h2>
                <nav class="settings-nav">
                    <button type="button" data-settings-tab="control" class="active">Inverter</button>
                    <button type="button" data-settings-tab="battery">Battery</button>
                    <button type="button" data-settings-tab="prices">Grid</button>
                    <button type="button" data-settings-tab="loads">Flexible Loads</button>
                    <button type="button" data-settings-tab="training">Training</button>
                </nav>
                <div class="settings-content">
                    <div data-settings-panel="control" class="settings-panel active">
                        <h3>Inverter Control</h3>
                        <p class="message">Configure Home Assistant entities and the inverter driver.</p>
                        <form id="controlForm" class="settings-form" autocomplete="off">
                            <div class="field">
                                <label for="driverSelect">Inverter driver</label>
                                <select id="driverSelect">
                                    <option value="">Select a driver...</option>
                                </select>
                            </div>
                            <div id="haEntitiesTableContainer"></div>
                            <div class="field checkbox-field">
                                <label class="checkbox" for="exportLimitToggle">
                                    <input type="checkbox" id="exportLimitToggle" aria-describedby="exportLimitHint" />
                                    <span>PV power reading false when export disabled <span class="tooltip-icon"
                                            data-tooltip="Enable when export throttling keeps PV power below the array's potential (e.g. once batteries are full).">?</span></span>
                                </label>
                            </div>
                            <p class="message" id="controlMessage" style="display:none;"></p>
                    </div>
                    </form>
                </div>
                <div data-settings-panel="battery" class="settings-panel">
                    <h3>Battery Settings</h3>
                    <p class="message">Set how much each kWh of battery throughput should cost to reflect wear.</p>
                    <form id="batteryForm" class="settings-form" autocomplete="off">
                        <div class="field">
                            <label for="batteryCapacityInput">Usable capacity (kWh) <span class="tooltip-icon"
                                    data-tooltip="Defines how much energy the optimization can store in the battery.">?</span></label>
                            <input type="number" id="batteryCapacityInput" min="0.1" step="0.1" inputmode="decimal"
                                aria-describedby="batteryCapacityHint" />
                        </div>
                        <div class="field">
                            <label for="batteryPowerInput">Charge / discharge limit (kW) <span class="tooltip-icon"
                                    data-tooltip="Set to the inverter's continuous charge or discharge power limit.">?</span></label>
                            <input type="number" id="batteryPowerInput" min="0.1" step="0.1" inputmode="decimal"
                                aria-describedby="batteryPowerHint" />
                        </div>
                        <div class="field">
                            <label for="batterySocMinInput">Reserve floor (% SoC) <span class="tooltip-icon"
                                    data-tooltip="Keep at least this much charge reserved for resiliency.">?</span></label>
                            <input type="number" id="batterySocMinInput" min="0" max="98" step="1" inputmode="decimal"
                                aria-describedby="batterySocMinHint" />
                        </div>
                        <div class="field">
                            <label for="batterySocMaxInput">Maximum usable SoC (%) <span class="tooltip-icon"
                                    data-tooltip="Upper bound on usable charge to limit battery wear.">?</span></label>
                            <input type="number" id="batterySocMaxInput" min="2" max="100" step="1" inputmode="decimal"
                                aria-describedby="batterySocMaxHint" />
                        </div>
                        <div class="field">
                            <label for="batteryWearInput">Battery wear cost (€/kWh) <span class="tooltip-icon"
                                    data-tooltip="Applied as a throughput penalty in the optimization to limit excessive cycling.">?</span></label>
                            <input type="number" id="batteryWearInput" min="0" step="0.01" inputmode="decimal"
                                aria-describedby="batteryWearHint" />
                        </div>
                        <p class="message" id="batteryMessage" style="display:none;"></p>
                    </form>
                </div>
                <div data-settings-panel="prices" class="settings-panel">
                    <h3>Grid Settings</h3>
                    <p class="message">Connect to tariff providers or override price profiles for optimization.</p>
                    <form id="pricingForm" class="settings-form" autocomplete="off">
                        <fieldset class="tariff-group">
                            <legend>Grid import</legend>
                            <div class="field">
                                <label for="importTariffMode">Mode <span class="tooltip-icon"
                                        data-tooltip="Apply a single fixed rate to every interval.">?</span></label>
                                <select id="importTariffMode" aria-describedby="importTariffHint">
                                    <option value="constant">Constant price</option>
                                    <option value="spot_plus_constant">Spot price with offset</option>
                                    <option value="dual_rate">Dual-rate schedule</option>
                                </select>
                            </div>
                            <div class="field" id="importConstantField" data-tariff-scope="import"
                                data-tariff-mode="constant" style="display:none;">
                                <label for="importConstantPrice">Import price (€/kWh) <span class="tooltip-icon"
                                        data-tooltip="Used for every interval when constant pricing is selected.">?</span></label>
                                <input type="number" id="importConstantPrice" min="0" step="0.001"
                                    inputmode="decimal" />
                            </div>
                            <div class="field" id="importSpotOffsetField" data-tariff-scope="import"
                                data-tariff-mode="spot_plus_constant" style="display:none;">
                                <label for="importSpotOffset">Offset from spot price (€/kWh) <span class="tooltip-icon"
                                        data-tooltip="Positive values raise import prices; negative values lower them relative to the spot signal.">?</span></label>
                                <input type="number" id="importSpotOffset" step="0.001" inputmode="decimal" />
                            </div>
                            <div class="field" data-tariff-scope="import" data-tariff-mode="dual_rate"
                                style="display:none;">
                                <label for="importPeakRate">Peak price (€/kWh)</label>
                                <input type="number" id="importPeakRate" min="0" step="0.001" inputmode="decimal" />
                            </div>
                            <div class="field" data-tariff-scope="import" data-tariff-mode="dual_rate"
                                style="display:none;">
                                <label for="importOffpeakRate">Off-peak price (€/kWh)</label>
                                <input type="number" id="importOffpeakRate" min="0" step="0.001" inputmode="decimal" />
                            </div>
                            <div class="field" data-tariff-scope="import" data-tariff-mode="dual_rate"
                                style="display:none;">
                                <label for="importPeakStart">Peak start (local time)</label>
                                <input type="text" id="importPeakStart" inputmode="numeric"
                                    pattern="^([01]\d|2[0-3]):[0-5]\d$" placeholder="07:00" />
                            </div>
                            <div class="field" data-tariff-scope="import" data-tariff-mode="dual_rate"
                                style="display:none;">
                                <label for="importPeakEnd">Peak end (local time) <span class="tooltip-icon"
                                        data-tooltip="Intervals between start and end use the peak rate; others use the off-peak rate.">?</span></label>
                                <input type="text" id="importPeakEnd" inputmode="numeric"
                                    pattern="^([01]\d|2[0-3]):[0-5]\d$" placeholder="21:00" />
                            </div>
                        </fieldset>
                        <fieldset class="tariff-group">
                            <legend>Grid export</legend>
                            <div class="field checkbox-field">
                                <label class="checkbox" for="exportEnabledToggle">
                                    <input type="checkbox" id="exportEnabledToggle" />
                                    <span>Enable export</span>
                                </label>
                            </div>
                            <div id="exportSettingsContainer">
                                <div class="field">
                                    <label for="exportPowerLimit">Export power limit (kW) <span class="tooltip-icon"
                                            data-tooltip="Maximum power allowed to be exported to the grid. Leave empty for no limit.">?</span></label>
                                    <input type="number" id="exportPowerLimit" min="0" step="0.1" inputmode="decimal" />
                                </div>
                                <div class="field">
                                    <label for="exportTariffMode">Mode <span class="tooltip-icon"
                                            data-tooltip="Apply a single fixed rate to every interval.">?</span></label>
                                    <select id="exportTariffMode" aria-describedby="exportTariffHint">
                                        <option value="constant">Constant price</option>
                                        <option value="spot_plus_constant">Spot price with offset</option>
                                        <option value="dual_rate">Dual-rate schedule</option>
                                    </select>
                                </div>
                                <div class="field" id="exportConstantField" data-tariff-scope="export"
                                    data-tariff-mode="constant" style="display:none;">
                                    <label for="exportConstantPrice">Export price (€/kWh) <span class="tooltip-icon"
                                            data-tooltip="Used for every interval when constant pricing is selected.">?</span></label>
                                    <input type="number" id="exportConstantPrice" min="0" step="0.001"
                                        inputmode="decimal" />
                                </div>
                                <div class="field" id="exportSpotOffsetField" data-tariff-scope="export"
                                    data-tariff-mode="spot_plus_constant" style="display:none;">
                                    <label for="exportSpotOffset">Offset from spot price (€/kWh) <span
                                            class="tooltip-icon"
                                            data-tooltip="Positive values raise export revenue; negative values lower it relative to the spot tariff.">?</span></label>
                                    <input type="number" id="exportSpotOffset" step="0.001" inputmode="decimal" />
                                </div>
                                <div class="field" data-tariff-scope="export" data-tariff-mode="dual_rate"
                                    style="display:none;">
                                    <label for="exportPeakRate">Peak price (€/kWh)</label>
                                    <input type="number" id="exportPeakRate" min="0" step="0.001" inputmode="decimal" />
                                </div>
                                <div class="field" data-tariff-scope="export" data-tariff-mode="dual_rate"
                                    style="display:none;">
                                    <label for="exportOffpeakRate">Off-peak price (€/kWh)</label>
                                    <input type="number" id="exportOffpeakRate" min="0" step="0.001"
                                        inputmode="decimal" />
                                </div>
                                <div class="field" data-tariff-scope="export" data-tariff-mode="dual_rate"
                                    style="display:none;">
                                    <label for="exportPeakStart">Peak start (local time)</label>
                                    <input type="text" id="exportPeakStart" inputmode="numeric"
                                        pattern="^([01]\d|2[0-3]):[0-5]\d$" placeholder="07:00" />
                                </div>
                                <div class="field" data-tariff-scope="export" data-tariff-mode="dual_rate"
                                    style="display:none;">
                                    <label for="exportPeakEnd">Peak end (local time) <span class="tooltip-icon"
                                            data-tooltip="Intervals between start and end use the peak rate; others use the off-peak rate.">?</span></label>
                                    <input type="text" id="exportPeakEnd" inputmode="numeric"
                                        pattern="^([01]\d|2[0-3]):[0-5]\d$" placeholder="21:00" />
                                </div>
                            </div>
                        </fieldset>
                        <p class="message" id="pricingMessage" style="display:none;"></p>
                    </form>
                </div>
                <div data-settings-panel="loads" class="settings-panel">
                    <h3>Deferrable Loads</h3>
                    <p class="description">Define large appliances (EVs, Heat Pumps) to separate them from base house
                        consumption. This improves prediction accuracy by removing irregular spikes from the history.
                    </p>

                    <div id="deferrableLoadsList" class="settings-list">
                        <!-- Items injected via JS -->
                    </div>

                    <button type="button" id="addLoadBtn" class="secondary" style="margin-top: 1rem;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" style="vertical-align: text-bottom; margin-right: 4px;">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Add Load
                    </button>

                    <template id="loadItemTemplate">
                        <div class="load-item">
                            <div class="load-header">
                                <!-- Left: Icon + Title -->
                                <div class="load-header-left" style="display:flex; align-items:center; gap:0.75rem;">
                                    <svg class="load-toggle-icon" viewBox="0 0 24 24">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                    <span class="load-header-title">New Load</span>
                                </div>

                                <!-- Right: Toggle -->
                                <div class="load-header-right"
                                    style="margin-left: auto; display:flex; align-items:center;">
                                    <!-- Enable Switch (Stop propagation in JS) -->
                                    <label class="toggle-switch-mini" style="display:flex; align-items:center;"
                                        title="Enable/Disable Load">
                                        <input type="checkbox" class="load-enabled-toggle">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>

                            <div class="load-content">
                                <div
                                    style="display:flex; justify-content:flex-end; margin-bottom: -1rem; position: relative; z-index: 10;">
                                    <button type="button" class="remove-load-btn" title="Remove Load">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            width="20" height="20">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path
                                                d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                            </path>
                                        </svg>
                                    </button>
                                </div>

                                <!-- Section 1: Basic Info -->
                                <div style="display:flex; flex-direction:column; gap:1rem; margin-bottom:1rem;">
                                    <div class="field">
                                        <label>Name</label>
                                        <input type="text" class="load-name" placeholder="e.g. Pool Pump">
                                    </div>
                                    <div class="field">
                                        <label>Nominal power (kW)</label>
                                        <input type="number" step="0.1" min="0" class="load-nominal-power"
                                            placeholder="0.0">
                                    </div>
                                    <div class="field">
                                        <label>Power sensor (Optional) <span class="tooltip-icon"
                                                data-tooltip="Used for precise history logging. If omitted, nominal power is assumed.">?</span></label>
                                        <button type="button" class="load-power-entity entity-select-btn">Select
                                            sensor...</button>
                                    </div>
                                </div>

                                <hr style="border:0; border-top:1px solid var(--border-color); margin: 1rem 0;">

                                <!-- Section 2: Control Strategy & Entities -->
                                <div class="field">
                                    <label>Control strategy</label>
                                    <div
                                        style="background: var(--bg-subtle); padding: 1rem; border-radius: 6px; border: 1px solid var(--border-color);">

                                        <!-- Control Type Select -->
                                        <div class="field">
                                            <label style="font-weight:600; color:var(--text-primary);">1. Control
                                                type</label>
                                            <select class="load-control-type" style="width:100%;">
                                                <option value="on_off">On/Off (Binary)</option>
                                                <option value="continuous">Continuous (Variable)</option>
                                            </select>
                                            <p class="control-type-desc"
                                                style="font-size:0.8rem; color:var(--text-secondary); margin-top:4px;">
                                                <!-- Dynamic Description populated by JS potentially, or static help -->
                                            </p>
                                        </div>

                                        <!-- Optimization Mode (Continuous Only) or Strategy Label (Binary) -->
                                        <div class="field opt-mode-field" style="margin-top:1rem;">
                                            <label style="font-weight:600; color:var(--text-primary);">2. Optimization
                                                mode <span class="tooltip-icon"
                                                    data-tooltip="Constant: Load runs at fixed power. Decreasing: Power adjusts based on optimization curve.">?</span></label>
                                            <select class="load-opt-mode" style="width:100%;">
                                                <option value="smart_dump">Constant value</option>
                                                <option value="custom_curve">Decreasing value</option>
                                            </select>
                                        </div>

                                        <!-- Entities Group -->
                                        <div style="margin-top:1.5rem;">
                                            <label
                                                style="font-weight:600; color:var(--text-primary); margin-bottom:0.5rem; display:block;">3.
                                                Controlled entities</label>

                                            <!-- Switch Entity -->
                                            <div class="field" style="margin-bottom:0.75rem;">
                                                <label class="switch-entity-label" style="font-size:0.9rem;">
                                                    <span class="label-text">Switch entity</span>
                                                    <span class="tooltip-icon"
                                                        data-tooltip="Entity to toggle the load ON/OFF. Required for Binary control.">?</span>
                                                </label>
                                                <button type="button" class="load-switch-entity entity-select-btn"
                                                    data-domain="switch">Select switch...</button>
                                            </div>

                                            <!-- Variable Power Entity -->
                                            <div class="field load-variable-power-container"
                                                style="margin-bottom:0.75rem;">
                                                <label class="var-power-entity-label" style="font-size:0.9rem;">
                                                    <span class="label-text">Variable power entity</span>
                                                    <span class="tooltip-icon"
                                                        data-tooltip="Entity to set the current power limit (e.g. EV charger current).">?</span>
                                                </label>
                                                <button type="button"
                                                    class="load-variable-power-entity entity-select-btn"
                                                    data-domain="number">Select number...</button>
                                            </div>


                                        </div>

                                        <!-- Tuning Parameters Group (Moved Inside) -->
                                        <div
                                            style="margin-top:1.5rem; border-top: 1px dashed var(--border-color); padding-top: 1rem;">
                                            <label
                                                style="font-weight:600; color:var(--text-primary); margin-bottom:0.5rem; display:block;">4.
                                                Tuning parameters</label>

                                            <div class="load-config-block"
                                                style="border:none; padding:0; background:none;">
                                                <div class="field param-start-value">
                                                    <label>Start value (€/kWh) <span class="tooltip-icon"
                                                            data-tooltip="Price threshold to start running. Higher means higher priority.">?</span></label>
                                                    <input type="number" step="0.01" class="load-opt-start-value"
                                                        placeholder="0.05">
                                                </div>

                                                <div class="field param-saturation">
                                                    <label>Saturation point (kWh) <span class="tooltip-icon"
                                                            data-tooltip="Daily energy amount where value drops to zero (Target Limit).">?</span></label>
                                                    <input type="number" step="0.1" min="0" class="load-opt-saturation"
                                                        placeholder="10.0">
                                                </div>

                                                <div class="field param-max-energy" style="display:none;">
                                                    <label>Max energy (kWh) <span class="tooltip-icon"
                                                            data-tooltip="Strict limit on daily consumption. Leave empty for unlimited.">?</span></label>
                                                    <input type="number" step="0.1" min="0" class="load-opt-max-energy"
                                                        placeholder="Unlimited">
                                                </div>

                                                <div class="checkbox-field param-overshoot">
                                                    <label class="checkbox">
                                                        <input type="checkbox" class="load-opt-overshoot">
                                                        Stop immediately when full
                                                        <span class="tooltip-icon"
                                                            data-tooltip="If unchecked, continues as dump load if energy is cheap.">?</span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>


                            </div>
                        </div>
                    </template>
                </div>
                <div data-settings-panel="training" class="settings-panel">
                    <h3>Model training</h3>
                    <p class="message">Configure automated model retraining.</p>
                    <form id="trainingForm" class="settings-form" autocomplete="off">
                        <div class="field checkbox-field">
                            <label class="checkbox" for="autoTrainingToggle">
                                <input type="checkbox" id="autoTrainingToggle" />
                                <span>Enable automatic nightly training (02:00 UTC) <span class="tooltip-icon"
                                        data-tooltip="Automatically retrain models every night to adapt to changing conditions.">?</span></span>
                            </label>
                        </div>
                    </form>
                </div>
        </div>
        </section>
        </div>
    </main>
    <div id="entityModal" class="entity-modal" role="dialog" aria-modal="true" aria-labelledby="entityModalTitle">
        <div id="entityModalBackdrop" class="entity-modal-backdrop"></div>
        <div class="entity-modal-content">
            <div class="entity-modal-header">
                <h3 id="entityModalTitle">Select sensor</h3>
                <button type="button" id="entityModalClose" class="entity-modal-close"
                    aria-label="Close selector">×</button>
            </div>
            <div class="entity-modal-body">
                <input type="search" id="entitySearch" placeholder="Search sensors…" autocomplete="off" />
                <div id="entityList" class="entity-list" role="listbox" aria-labelledby="entityModalTitle"></div>
            </div>
            <div class="entity-modal-footer">
                <button type="button" id="entityModalCancel">Cancel</button>
            </div>
        </div>
    </div>
    <script src="static/app.js" defer></script>

</body>

</html>