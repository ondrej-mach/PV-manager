<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PV Manager</title>
    <link rel="stylesheet" href="/static/app.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" defer></script>
</head>

<body>
    <header>
        <div class="header-left">
            <h1>PV Manager</h1>
        </div>
        <button type="button" class="secondary" id="settingsBtn">Settings</button>
    </header>
    <main>
        <div id="mainView" class="view">
            <section class="card">
                <h2>System Overview</h2>
                <div class="control-row">
                    <label class="switch-label" for="controlSwitch">Automatic control</label>
                    <button id="controlSwitch" class="toggle-switch" role="switch" aria-checked="false">
                        <span class="knob"></span>
                    </button>
                </div>
                <div id="interventionBanner" class="intervention-banner none" style="margin-top: 1rem;">Current
                    intervention: Not available</div>
                <div id="error" class="message error"></div>
                <div class="summary-grid" id="summaryGrid">
                    <div class="summary-item">
                        <span class="summary-label">Import (kWh)</span>
                        <span class="summary-value" id="summary-import">--</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Export (kWh)</span>
                        <span class="summary-value" id="summary-export">--</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Net Cost (€)</span>
                        <span class="summary-value" id="summary-net">--</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">PV energy (kWh)</span>
                        <span class="summary-value" id="summary-pv-energy">--</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Consumption (kWh)</span>
                        <span class="summary-value" id="summary-load">--</span>
                    </div>
                </div>
                <div id="summaryWindow" class="meta"></div>
                <div id="trainingState" class="training-state">Training status unknown.</div>
                <div id="trainingError" class="training-state error" style="display:none;"></div>
                <div id="cycleMessage" class="message" style="display:none;"></div>
                <div class="actions">
                    <button type="button" id="cycleBtn">Recompute Plan</button>
                    <button type="button" id="trainBtn">Trigger Training</button>
                </div>
            </section>

            <section class="card">
                <h2>Forecast vs Load</h2>
                <p class="meta">Last updated: <span id="lastUpdated">waiting…</span></p>
                <div id="forecastMessage" class="message"></div>
                <div class="chart-container chart-forecast">
                    <canvas id="forecastChart" height="320"></canvas>
                </div>
            </section>

            <section class="card">
                <h2>Optimization Plan</h2>
                <div class="optimization-charts">
                    <div class="optimization-block">
                        <h3 class="chart-subtitle">Price &amp; battery state</h3>
                        <div class="chart-container chart-plan">
                            <canvas id="planChart" height="320"></canvas>
                        </div>
                    </div>
                    <div class="optimization-block">
                        <h3 class="chart-subtitle">Grid exchange</h3>
                        <div class="chart-container chart-grid">
                            <canvas id="gridChart" height="320"></canvas>
                        </div>
                    </div>
                </div>
        </div>
        </section>
        </div>
        <div id="settingsView" class="view hidden">
            <section class="card">
                <h2>Settings</h2>
                <nav class="settings-nav">
                    <button type="button" data-settings-tab="inverter" class="active">Inverter</button>
                    <button type="button" data-settings-tab="battery">Battery</button>
                    <button type="button" data-settings-tab="pv">PV System</button>
                    <button type="button" data-settings-tab="prices">Energy Prices</button>
                    <button type="button" data-settings-tab="loads">Flexible Loads</button>
                    <button type="button" data-settings-tab="control">Inverter Control</button>
                </nav>
                <div class="settings-content">
                    <div data-settings-panel="inverter" class="settings-panel active">
                        <h3>Inverter Settings</h3>
                        <p class="message">Select which Home Assistant statistics feed the house consumption and PV
                            power forecasts. Values are normalized to kW automatically.</p>
                        <form id="inverterForm" class="settings-form" autocomplete="off">
                            <div class="field">
                                <label id="houseEntityLabelText">House consumption sensor</label>
                                <button type="button" id="houseEntityTrigger" class="entity-trigger"
                                    data-target="house_consumption"
                                    aria-labelledby="houseEntityLabelText houseEntityLabel">
                                    <span class="entity-trigger-text" id="houseEntityLabel">None</span>
                                    <span class="entity-trigger-hint" aria-hidden="true">⌄</span>
                                </button>
                                <p class="hint" id="houseHint">Waiting for Home Assistant…</p>
                            </div>
                            <p class="message" id="inverterMessage" style="display:none;"></p>
                        </form>
                    </div>
                    <div data-settings-panel="control" class="settings-panel">
                        <h3>Inverter Control</h3>
                        <p class="message">Configure how the add-on controls your inverter. Select a driver and map the
                            required entities.</p>
                        <form id="controlForm" class="settings-form" autocomplete="off">
                            <div class="field">
                                <label for="driverSelect">Inverter Driver</label>
                                <select id="driverSelect">
                                    <option value="">Select a driver...</option>
                                </select>
                            </div>
                            <div id="driverConfigContainer"></div>
                            <p class="message" id="controlMessage" style="display:none;"></p>
                            <div class="actions">
                                <button type="button" id="saveControlBtn" class="primary">Save Configuration</button>
                            </div>
                        </form>
                    </div>
                    <div data-settings-panel="battery" class="settings-panel">
                        <h3>Battery Settings</h3>
                        <p class="message">Link a Home Assistant sensor that reports battery state of charge and set how
                            much each kWh of battery throughput should cost to reflect wear.</p>
                        <form id="batteryForm" class="settings-form" autocomplete="off">
                            <div class="field">
                                <label id="batterySocLabelText">Battery SoC sensor</label>
                                <button type="button" id="batterySocTrigger" class="entity-trigger"
                                    data-target="battery_soc" aria-labelledby="batterySocLabelText batterySocLabel">
                                    <span class="entity-trigger-text" id="batterySocLabel">None</span>
                                    <span class="entity-trigger-hint" aria-hidden="true">⌄</span>
                                </button>
                                <p class="hint" id="batterySocHint">Choose a sensor reporting battery charge in percent
                                    (0-100) or fraction (0-1).</p>
                            </div>
                            <div class="field">
                                <label for="batteryCapacityInput">Usable capacity (kWh)</label>
                                <input type="number" id="batteryCapacityInput" min="0.1" step="0.1" inputmode="decimal"
                                    aria-describedby="batteryCapacityHint" />
                                <p class="hint" id="batteryCapacityHint">Defines how much energy the optimization can
                                    store in the battery.</p>
                            </div>
                            <div class="field">
                                <label for="batteryPowerInput">Charge / discharge limit (kW)</label>
                                <input type="number" id="batteryPowerInput" min="0.1" step="0.1" inputmode="decimal"
                                    aria-describedby="batteryPowerHint" />
                                <p class="hint" id="batteryPowerHint">Set to the inverter&apos;s continuous charge or
                                    discharge power limit.</p>
                            </div>
                            <div class="field">
                                <label for="batterySocMinInput">Reserve floor (% SoC)</label>
                                <input type="number" id="batterySocMinInput" min="0" max="98" step="1"
                                    inputmode="decimal" aria-describedby="batterySocMinHint" />
                                <p class="hint" id="batterySocMinHint">Keep at least this much charge reserved for
                                    resiliency.</p>
                            </div>
                            <div class="field">
                                <label for="batterySocMaxInput">Maximum usable SoC (%)</label>
                                <input type="number" id="batterySocMaxInput" min="2" max="100" step="1"
                                    inputmode="decimal" aria-describedby="batterySocMaxHint" />
                                <p class="hint" id="batterySocMaxHint">Upper bound on usable charge to limit battery
                                    wear.</p>
                            </div>
                            <div class="field">
                                <label for="batteryWearInput">Battery wear cost (€/kWh)</label>
                                <input type="number" id="batteryWearInput" min="0" step="0.01" inputmode="decimal"
                                    aria-describedby="batteryWearHint" />
                                <p class="hint" id="batteryWearHint">Applied as a throughput penalty in the optimization
                                    to limit excessive cycling.</p>
                            </div>
                            <p class="message" id="batteryMessage" style="display:none;"></p>
                        </form>
                    </div>
                    <div data-settings-panel="pv" class="settings-panel">
                        <h3>PV System Settings</h3>
                        <p class="message">Manage installed PV capacity, panel orientation, and performance factors.</p>
                        <form id="pvSystemForm" class="settings-form" autocomplete="off">
                            <div class="field">
                                <label id="pvEntityLabelText">PV production sensor</label>
                                <button type="button" id="pvEntityTrigger" class="entity-trigger" data-target="pv_power"
                                    aria-labelledby="pvEntityLabelText pvEntityLabel">
                                    <span class="entity-trigger-text" id="pvEntityLabel">None</span>
                                    <span class="entity-trigger-hint" aria-hidden="true">⌄</span>
                                </button>
                                <p class="hint" id="pvHint">Waiting for Home Assistant…</p>
                            </div>
                            <div class="field checkbox-field">
                                <label class="checkbox" for="exportLimitToggle">
                                    <input type="checkbox" id="exportLimitToggle" aria-describedby="exportLimitHint" />
                                    <span>PV power is limited by the inverter</span>
                                </label>
                                <p class="hint" id="exportLimitHint">Enable when export throttling keeps PV power below
                                    the array&apos;s potential once batteries are full.</p>
                            </div>
                        </form>
                    </div>
                    <div data-settings-panel="prices" class="settings-panel">
                        <h3>Energy Price Settings</h3>
                        <p class="message">Connect to tariff providers or override price profiles for optimization.</p>
                        <form id="pricingForm" class="settings-form" autocomplete="off">
                            <fieldset class="tariff-group">
                                <legend>Grid import</legend>
                                <div class="field">
                                    <label for="importTariffMode">Mode</label>
                                    <select id="importTariffMode" aria-describedby="importTariffHint">
                                        <option value="constant">Constant price</option>
                                        <option value="spot_plus_constant">Spot price with offset</option>
                                        <option value="dual_rate">Dual-rate schedule</option>
                                    </select>
                                    <p class="hint" id="importTariffHint">Apply a single fixed rate to every interval.
                                    </p>
                                </div>
                                <div class="field" id="importConstantField" data-tariff-scope="import"
                                    data-tariff-mode="constant" style="display:none;">
                                    <label for="importConstantPrice">Import price (€/kWh)</label>
                                    <input type="number" id="importConstantPrice" min="0" step="0.001"
                                        inputmode="decimal" />
                                    <p class="hint">Used for every interval when constant pricing is selected.</p>
                                </div>
                                <div class="field" id="importSpotOffsetField" data-tariff-scope="import"
                                    data-tariff-mode="spot_plus_constant" style="display:none;">
                                    <label for="importSpotOffset">Offset from spot price (€/kWh)</label>
                                    <input type="number" id="importSpotOffset" step="0.001" inputmode="decimal" />
                                    <p class="hint">Positive values raise import prices; negative values lower them
                                        relative to the spot signal.</p>
                                </div>
                                <div class="field" data-tariff-scope="import" data-tariff-mode="dual_rate"
                                    style="display:none;">
                                    <label for="importPeakRate">Peak price (€/kWh)</label>
                                    <input type="number" id="importPeakRate" min="0" step="0.001" inputmode="decimal" />
                                </div>
                                <div class="field" data-tariff-scope="import" data-tariff-mode="dual_rate"
                                    style="display:none;">
                                    <label for="importOffpeakRate">Off-peak price (€/kWh)</label>
                                    <input type="number" id="importOffpeakRate" min="0" step="0.001"
                                        inputmode="decimal" />
                                </div>
                                <div class="field" data-tariff-scope="import" data-tariff-mode="dual_rate"
                                    style="display:none;">
                                    <label for="importPeakStart">Peak start (local time)</label>
                                    <input type="text" id="importPeakStart" inputmode="numeric"
                                        pattern="^([01]\d|2[0-3]):[0-5]\d$" placeholder="07:00" />
                                </div>
                                <div class="field" data-tariff-scope="import" data-tariff-mode="dual_rate"
                                    style="display:none;">
                                    <label for="importPeakEnd">Peak end (local time)</label>
                                    <input type="text" id="importPeakEnd" inputmode="numeric"
                                        pattern="^([01]\d|2[0-3]):[0-5]\d$" placeholder="21:00" />
                                    <p class="hint">Intervals between start and end use the peak rate; others use the
                                        off-peak rate.</p>
                                </div>
                            </fieldset>
                            <fieldset class="tariff-group">
                                <legend>Grid export</legend>
                                <div class="field">
                                    <label for="exportTariffMode">Mode</label>
                                    <select id="exportTariffMode" aria-describedby="exportTariffHint">
                                        <option value="constant">Constant price</option>
                                        <option value="spot_plus_constant">Spot price with offset</option>
                                        <option value="dual_rate">Dual-rate schedule</option>
                                    </select>
                                    <p class="hint" id="exportTariffHint">Apply a single fixed rate to every interval.
                                    </p>
                                </div>
                                <div class="field" id="exportConstantField" data-tariff-scope="export"
                                    data-tariff-mode="constant" style="display:none;">
                                    <label for="exportConstantPrice">Export price (€/kWh)</label>
                                    <input type="number" id="exportConstantPrice" min="0" step="0.001"
                                        inputmode="decimal" />
                                    <p class="hint">Used for every interval when constant pricing is selected.</p>
                                </div>
                                <div class="field" id="exportSpotOffsetField" data-tariff-scope="export"
                                    data-tariff-mode="spot_plus_constant" style="display:none;">
                                    <label for="exportSpotOffset">Offset from spot price (€/kWh)</label>
                                    <input type="number" id="exportSpotOffset" step="0.001" inputmode="decimal" />
                                    <p class="hint">Positive values raise export revenue; negative values lower it
                                        relative to the spot tariff.</p>
                                </div>
                                <div class="field" data-tariff-scope="export" data-tariff-mode="dual_rate"
                                    style="display:none;">
                                    <label for="exportPeakRate">Peak price (€/kWh)</label>
                                    <input type="number" id="exportPeakRate" min="0" step="0.001" inputmode="decimal" />
                                </div>
                                <div class="field" data-tariff-scope="export" data-tariff-mode="dual_rate"
                                    style="display:none;">
                                    <label for="exportOffpeakRate">Off-peak price (€/kWh)</label>
                                    <input type="number" id="exportOffpeakRate" min="0" step="0.001"
                                        inputmode="decimal" />
                                </div>
                                <div class="field" data-tariff-scope="export" data-tariff-mode="dual_rate"
                                    style="display:none;">
                                    <label for="exportPeakStart">Peak start (local time)</label>
                                    <input type="text" id="exportPeakStart" inputmode="numeric"
                                        pattern="^([01]\d|2[0-3]):[0-5]\d$" placeholder="07:00" />
                                </div>
                                <div class="field" data-tariff-scope="export" data-tariff-mode="dual_rate"
                                    style="display:none;">
                                    <label for="exportPeakEnd">Peak end (local time)</label>
                                    <input type="text" id="exportPeakEnd" inputmode="numeric"
                                        pattern="^([01]\d|2[0-3]):[0-5]\d$" placeholder="21:00" />
                                    <p class="hint">Intervals between start and end use the peak rate; others use the
                                        off-peak rate.</p>
                                </div>
                            </fieldset>
                            <p class="message" id="pricingMessage" style="display:none;"></p>
                        </form>
                    </div>
                    <div data-settings-panel="loads" class="settings-panel">
                        <h3>Flexible Loads</h3>
                        <p class="message">Schedule controllable appliances and flexibility windows for automation.</p>
                    </div>
                </div>
            </section>
        </div>
    </main>
    <div id="entityModal" class="entity-modal" role="dialog" aria-modal="true" aria-labelledby="entityModalTitle">
        <div id="entityModalBackdrop" class="entity-modal-backdrop"></div>
        <div class="entity-modal-content">
            <div class="entity-modal-header">
                <h3 id="entityModalTitle">Select sensor</h3>
                <button type="button" id="entityModalClose" class="entity-modal-close"
                    aria-label="Close selector">×</button>
            </div>
            <div class="entity-modal-body">
                <input type="search" id="entitySearch" placeholder="Search sensors…" autocomplete="off" />
                <div id="entityList" class="entity-list" role="listbox" aria-labelledby="entityModalTitle"></div>
            </div>
            <div class="entity-modal-footer">
                <button type="button" id="entityModalCancel">Cancel</button>
            </div>
        </div>
    </div>
    <script src="/static/app.js" defer></script>

</body>

</html>